# Contributor: C. Dylan Shearer <dylan@nekonya.info>
# Maintainer: C. Dylan Shearer <dylan@nekonya.info>
pkgname=jobber
pkgdesc="A replacement for cron, with sophisticated status-reporting and error-handling."
url="https://dshearer.github.io/${pkgname}/"
pkgver=1.4.0
pkgrel=0
arch="all"
license="MIT"
depends=""
depends_dev=""
makedepends="$depends_dev openrc go>=1.8 rsync"
install="${pkgname}.post-install ${pkgname}.pre-deinstall ${pkgname}.post-deinstall ${pkgname}.post-upgrade"
source="${pkgname}.initd ${pkgname}.tgz::https://github.com/dshearer/jobber/archive/v1.4.0.tar.gz"
_builddir="${startdir}/build"

prepare() {
        # make Go workspace
        mkdir -p "${_builddir}/src/github.com/dshearer"
        cp -r "${srcdir}/${pkgname}-${pkgver}" "${_builddir}/src/github.com/dshearer/"
        mv "${_builddir}/src/github.com/dshearer/${pkgname}-${pkgver}" "${_builddir}/src/github.com/dshearer/${pkgname}"
}

build() {
        echo Nothing to do
}

check() {
    export GOPATH="${_builddir}"
    export GO_WKSPC="${_builddir}"
    make -C "${_builddir}/src/github.com/dshearer/${pkgname}" check
}

package() {
    set -e

    # build and install
    export GOPATH="${_builddir}"
    export GO_WKSPC="${_builddir}"
                make -C "${_builddir}/src/github.com/dshearer/${pkgname}" \
                        install "DESTDIR=${pkgdir}/" prefix=/usr

    # install init script
                local INITD=${pkgdir}/etc/init.d
                mkdir -p "${INITD}"
                cp "${startdir}/${pkgname}.initd" "${INITD}/jobber"
}

sha512sums="7dacd120effe454daded552623c99bb1b695c6ce47819b7f627772a1f6ca494b5ff83adcae2693e35ef600e92268ef5066a92fc7522043316864edde6f892550  jobber.initd
ceb6522620cc35b07fa046f4669eff953e1668cd227f5f2f44aef0c669409c101a5d318a15f6ffa5ad280f74b6517978a8e26d6994bb95a8b291b69a54229f9a  jobber.tgz"
